---
title: "Mapping self references in Code First"
date: 2011-12-20T18:56:28Z
tags:
  - Entity Framework
redirect_from: /id/232594/
category: none
layout: post
---
<p>From time to time I see people having problems to map self references in <a href="http://msdn.microsoft.com/en-us/library/gg696172(v=vs.103).aspx">Code First in Entity Framework</a>. It might be confusing what to do with <a href="http://msdn.microsoft.com/en-us/library/gg671281(v=vs.103).aspx">HasMany</a>/<a href="http://msdn.microsoft.com/en-us/library/gg696687(v=VS.103).aspx">WithMany</a> and <a href="http://msdn.microsoft.com/en-us/library/gg671230(v=vs.103).aspx">HasOptional</a>/<a href="http://msdn.microsoft.com/en-us/library/gg679294(v=VS.103).aspx">WithOptional</a>.</p>

<p>So let's jump in. Define a pretty simple table:</p>
<pre class="brush:sql">
create table SelfRefs (
  ID int primary key,
  FooBar varchar(20) not null,
  ID_Parent int
);

alter table SelfRefs add foreign key (ID_Parent) references SelfRefs(ID);
</pre>

<p>The corresponding class could be:</p>
<pre class="brush:csharp">
class SelfRef
{
	public int ID { get; set; }
	public string FooBar { get; set; }
	public SelfRef ParentItem { get; set; }
	public int? ParentItemID { get; set; }
	public ICollection&lt;SelfRef&gt; ChildItems { get; set; }
}
</pre>

<p>Now the mapping. The "trick" here is to realize, that we have not only child->parent association, but also parent->children. The other one is implied from the first one. Hence every child item has optional parent. If the child item has no parent, it is actually a 1<sup>st</sup> level child, aka child of (invisible) "root" (<code>NULL</code> parent). That also means you can map it from both directions and result will be the same. Here's the example <small>(it's explicit a little more)</small> with both mappings (you can use both declarations together without any problem):</p>
<pre class="brush:csharp">
class SelfRefConfiguration : EntityTypeConfiguration&lt;SelfRef&gt;
{
	public SelfRefConfiguration()
	{
		this.HasKey(x =&gt; x.ID);
		this.Property(x =&gt; x.ParentItemID).HasColumnName("ID_Parent");
		// starting from child with parent
		//this.HasOptional(x =&gt; x.ParentItem).WithMany(x =&gt; x.ChildItems).HasForeignKey(x =&gt; x.ParentItemID).WillCascadeOnDelete(false);
		// starting from parent with children
		this.HasMany(x =&gt; x.ChildItems).WithOptional(x =&gt; x.ParentItem).HasForeignKey(x =&gt; x.ParentItemID).WillCascadeOnDelete(false);

		this.Map(map =&gt;
			{
				map.Properties(x =&gt; new { x.ID, x.FooBar, x.ParentItemID });
				map.ToTable("SelfRefs", "dbo");
			});
	}
}
</pre>

<p>Hope I made it a little bit more clear. If not, feel free to ask in comments.</p>