---
title: "TeamCity, PowerShell and sqlcmd problem (and solution)"
date: 2011-04-13T17:46:19Z
tags:
  - Continuous Integration
  - MS SQL Server
  - PowerShell
category: none
layout: post
---
<p>In my current project we're using <a href="http://www.jetbrains.com/teamcity/">TeamCity</a> as a continuous integration server and <a href="https://github.com/JamesKovacs/psake">psake</a> to run all out build and deployment tasks. Part of the deployment is execution of SQL scripts to create database and create structures in it. And as a heavy-duty console user, I'm using sqlcmd to do all my work with database. So I simply called sqlcmd with according parameters and to execute the scripts. Sadly for some strange reason, the <a href="http://technet.microsoft.com/en-us/library/bb978526.aspx">PowerShell</a> runner in TeamCity kept running in a loop eventually ending with timeout. Even worse, running it locally directly in PowerShell was fine. After small research done by my <a href="http://rarous.net">colleague</a> we found the reason is sqlcmd.</p>

<p>The quick'n'dirty solution was to run it using <a href="http://technet.microsoft.com/en-us/library/dd347667.aspx">Start-Process</a>, sadly we lost the output (using <code>-noNewWindow</code> resulted in same problem), so any error was about guessing. Simple techniques, like redirecting output from cmdlet ended with same problem.</p>

<p>But I actually found a solution. I redirected the output from sqlcmd directly with <code>-o</code> switch and used Unicode using <code>-u</code>. Then I echoed the file via <a href="http://technet.microsoft.com/en-us/library/dd347719.aspx">Get-Content</a> cmdlet with <code>-encoding Unicode</code> switch.</p>

<p>After I rigorously specified the encodings for output and input, everything started running fine. Probably there was some problem with BOM being in input, causing headache to the runner.</p>

<p>Never mind, now it's fine, and I'm happy, because I see errors in processing SQL scripts eventually.</p>