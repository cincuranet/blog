---
title: "Running commands on Firebird in background and canceling"
date: 2010-04-03T16:30:32Z
tags:
  - .NET
  - Firebird
redirect_from: /id/231316
category: none
layout: post
---
<p>The soon to be released Firebird 2.5 has a new ability to cancel running command (or any operation currently being processed by server) via API (in 2.1 you can do it via monitoring tables). This is a nice feature, interesting not only for database administration tools.</p>

<p>I was working on supporting it for a while in <a href="http://firebirdsql.org/index.php?op=files&id=netprovider">.NET provider</a>, but I'm happy to say that it's done (though I may tune the boundaries based on feedback). From some initial proposal in <a href="http://firebirdsql.org/index.php?op=lists">list</a> I picked one following the design of SqlClient, as it's a de facto standard in ADO.NET world.</p>

<p>So right now you can do:</p>

<pre class="brush:csharp">
using (FbConnection conn = new FbConnection(@"database=localhost:rrr.fdb;user=sysdba;password=masterkey"))
{
	conn.Open();
	//conn.DisableCancel();
	//conn.EnableCancel();
	using (FbCommand cmd = conn.CreateCommand())
	{
		cmd.CommandText =
@"execute block
as
declare cnt int;
begin
cnt = 999999999;
while (cnt > 0) do
begin
--cnt = cnt-100;
end
end";
		IAsyncResult ar = cmd.BeginExecuteNonQuery(null, null);
		Thread.Sleep(4000);
		Console.WriteLine("Canceling");
		cmd.Cancel();
		try
		{
			object result = cmd.EndExecuteNonQuery(ar);
		}
		catch(FbException ex)
		{
			Console.WriteLine(ex.Message);
		}
</pre>

<p>and you'll get the result (even though the loop in fact never ends):</p>

<pre class="brush:plain">
Canceling
operation was cancelled
</pre>

<p>Of course, you can screw things up by i.e. starting command and then trying to do something else with connection/transaction/command (the ADO.NET providers are not thread safe by default).</p>

<p>Oh, BTW, if you wanna test it, download <a href="http://netprovider.cincura.net/">weekly build</a>. ;)</p>