---
title: "SHA1Managed with asynchronous ComputeHash"
date: 2014-01-03T06:21:00Z
tags:
  - .NET
  - Cryptography
  - Multithreading/Parallelism/Asynchronous/Concurrency
  - C#
category: none
layout: post
---
<p>Mixing IO-bound and CPU-bound operations in a single chunk of code isn't always a base idea. Like computing hashes/checksums. You read the data from storage and you compute the hash. When all bytes are read, you're done. Of course you can do it as a producer-consumer with a ring buffer, but mixing IO-bound and CPU-bound here is damn straightforward.</p>
 
<p>If you look at <a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.sha1managed(v=vs.110).aspx"><code>SHA1Managed</code> class</a> you'll find <a href="http://msdn.microsoft.com/en-us/library/xa627k19(v=vs.110).aspx"><code>ComputeHash</code></a> method. Sadly it's synchronous. Thus if you'll point it to a huge file (i.e. <code>FileStream</code>) on a slow media you'll be wasting resources while waiting for the result. But given the reading from stream is basically the only IO operation here it shouldn't be hard to make it asynchronous. I thought.</p> 
<!-- excerpt -->
<p>I dug into the <code>ComputeHash</code> method and it's pretty simple. The IO operation that happens in loop can be easily transformed to asynchronous one and hence having whole method <code>ComputeHash</code> asynchronous. Welcome <code>ComputeHashAsync</code> for <code>SHA1Managed</code>.</p>

<pre class="brush:csharp">
public async Task&lt;byte[]&gt; ComputeHashAsync(Stream inputStream)
{
    byte[] array = new byte[4096];
    int num;
    do
    {
        num = await inputStream.ReadAsync(array, 0, 4096).ConfigureAwait(false);
        if (num &gt; 0)
        {
            this.HashCore(array, 0, num);
        }
    }
    while (num &gt; 0);
    this.HashValue = this.HashFinal();
    byte[] result = (byte[])this.HashValue.Clone();
    this.Initialize();
    return result;
}
</pre>

<p>It's what the <code>ComputeHash</code> is doing only using <code>ReadAsync</code> on a stream.</p>

<p>I hope the BCL team will provide asynchronous implementation out-of-the box in a foreseable future.</p>