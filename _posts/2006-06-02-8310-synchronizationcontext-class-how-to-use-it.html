---
title: "SynchronizationContext class - how to use it?"
date: 2006-06-02T19:55:00Z
tags:
  - .NET
category: devel
layout: post
---
<p>In .NET framework 2.0 is new class SynchronizationContext. This class can be very helpful when using threads and communication (and collaboration) between threads.</p><p>Before, if you want to i.e. do something with some control on form (or just do something in another thread) you have to use the Invoke method of the object (most common of form) and use the InvokeRequired property to determine how and what to do. This means, that the receiver must care about this stuff about threads. With the new SynchronizationContext class this logic is back in the sender. <br />Look at this code:</p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">public</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> <span style="COLOR: blue">partial</span> <span style="COLOR: blue">class</span> <span style="COLOR: teal">Form1</span> : <span style="COLOR: teal">Form< ?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" /><o :p></o></span></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">public</span> Form1()<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>InitializeComponent();<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>}<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">private</span> <span style="COLOR: blue">void</span> button1_Click(<span style="COLOR: blue">object</span> sender, <span style="COLOR: teal">EventArgs</span> e)<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: blue">new</span> <span style="COLOR: teal">Thread</span>(<span style="COLOR: blue">new</span> <span style="COLOR: teal">ThreadStart</span>(<span style="COLOR: blue">new</span> <span style="COLOR: teal">UsefulClass</span>(<span style="COLOR: blue">this</span>).DoWork)).Start();<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>}<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> AnotherDoWork(<span style="COLOR: blue">string</span> text)<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>button1.Text = text;<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>}<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>}<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span><span style="COLOR: blue">class</span> <span style="COLOR: teal">UsefulClass<o :p></o></span></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">private</span> <span style="COLOR: teal">Form1</span> _form;<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">private</span> <span style="COLOR: teal">SynchronizationContext</span> _context;<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">public</span> UsefulClass(<span style="COLOR: teal">Form1</span> form)<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>_form = form;</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>}<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE:
 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> DoWork()<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: teal">Thread</span>.Sleep(2000);<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>_form.AnotherDoWork(<span style="COLOR: maroon">"jirka"</span>);<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: teal">Thread</span>.Sleep(2000);<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>}<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>}</span></p><p>If you try to run it you will get InvalidOperationException exception saying that cross-thread operation is not valid. To solve this you have to modify the code using Invoke/BeginInvoke and InvokeRequired, as you know.</p><p>Now look at the example with SynchronizationContext class:</p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">class</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"> <span style="COLOR: teal">UsefulClass<o :p></o></span></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">private</span> <span style="COLOR: teal">Form1</span> _form;<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">private</span> <span style="COLOR: teal">SynchronizationContext</span> _context;<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">public</span> UsefulClass(<span style="COLOR: teal">Form1</span> form)<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>_form = form;<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>_context = <span style="COLOR: teal">SynchronizationContext</span>.Current;<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: blue">if</span> (_context == <span style="COLOR: blue">null</span>)<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span>_context = <span style="COLOR: blue">new</span> <span style="COLOR: teal">SynchronizationContext</span>();<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>}<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>}<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p> </o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span><span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> DoWork()<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>{<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: teal">Thread</span>.Sleep(2000);<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span>_context.Post(<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span><span style="COLOR: blue">new</span> <span style="COLOR: teal">SendOrPostCallback</span>(<span style="COLOR: blue">delegate</span> { _form.AnotherDoWork(<span style="COLOR: maroon">"jirka"</span>); }),<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 1
0pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">                </span><span style="COLOR: blue">null</span>);<span style="COLOR: green"><o :p></o></span></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">            </span><span style="COLOR: teal">Thread</span>.Sleep(2000);<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">        </span>}<o :p></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes">    </span>}</span></p><p>In the contructor of the class we get the SynchronizationContext from the Current property and if there's null we simply create a new one (this test is important, there's no need to exist the object in Current property). As you can see we're using the SynchronizationContext's method Post to "invoke" the method in right way. And that's all. There's also Send method for synchronous operation.</p><p>I hope this (really) easy example will help you with playing and understanding this class and threads.<br />Any comments welcome.</p>
