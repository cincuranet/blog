---
title: "Synchronizace threadů"
date: 2005-12-28T21:08:00Z
tags:
  - .NET
category: devel
layout: post
---
<p>Včera jsem se poku&#353;el napsat př&#237;klad, kter&#253; by demonstroval co se stane, pokud thready využ&#237;vaj&#237;c&#237; sd&#237;len&#253; prostředek nejsou synchronizov&#225;ny. Jak asi každ&#253; v&#237;, že se to tam a tam může pokazit, snaž&#237; se automaticky myslet tak, aby tomuto nedeterministick&#233;mu chov&#225;n&#237; přede&#353;el. J&#225; jsem v&#353;ak potřeboval napsat př&#237;klad, kter&#253; by toto z&#225;měrně poru&#353;oval. Pachtil jsem se s tim poměrně dlouho - myslel jsem si, že &#353;patn&#253; př&#237;klad lehce dok&#225;žu vytvořit - a hle, nen&#237; to tak jednoduch&#233;. :)</p><p>Pokud by tedy někdo potřeboval př&#237;klad, kter&#253; by toto uk&#225;zal, může využ&#237;t tento (těžce vymy&#353;len&#253; :) ):</p><font color=#0000ff size=2><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">using</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000> System;< ?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" /><o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">using</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000> System.Collections.Generic;<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">using</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000> System.Text;<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">using</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000> System.Threading;<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p><font color=#000000> </font></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Courier New'; mso-no-proof: yes">namespace</span><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000> synchro<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000>{<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>    </font></span><span style="COLOR: blue">class</span><font color=#000000> Program<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">    </span>{<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>        </font></span><span style="COLOR: blue">public</span><font color=#000000> </font><span style="COLOR: blue">static</span><font color=#000000> </font><span style="COLOR: blue">int</span><font color=#000000> globalni = 0;<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p><font color=#000000> </font></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>        </font></span><span style="COLOR: blue">static</span><font color=#000000> </font><span style="COLOR: blue">void</span><font color=#000000> Main(</font><span style="COLOR: blue">string</span><font color=#000000>[] args)<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">        </span>{<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>            </font></span><span style="COLOR: blue">for</span><font color=#000000> (</font><span style="COLOR: blue">int</span><font color=#000000> i = 0; i &lt; 5; i++)<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">            </span>{<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">                </span><o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>                </font></span><span style="COLOR: teal">ThreadStart</span><font color=#000000> ts = </font><span style="COLOR: blue">new</span><font color=#000000> </font><span style="COLOR: teal">ThreadStart</span><font color=#000000>((</font><span style="COLOR: blue">new</span><font color=#000000> Worker()).Run);<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>                </font></span><span style="COLOR: blue">new</span><font color=#000000> </font><span style="COLOR: teal">Thread</span><font color=#000000>(ts).Start();<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">            </span>}<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>            </font></span><span style="COLOR: teal">Console</span><font color=#000000>.ReadKey();<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">        </span>}<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">    </span>}<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p><font color=#000000> </font></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spac
erun: yes"><font color=#000000>    </font></span><span style="COLOR: blue">class</span><font color=#000000> Worker<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">    </span>{<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>        </font></span><span style="COLOR: blue">public</span><font color=#000000> Worker()<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">        </span>{<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">        </span>}<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><o :p><font color=#000000> </font></o></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>        </font></span><span style="COLOR: blue">public</span><font color=#000000> </font><span style="COLOR: blue">void</span><font color=#000000> Run()<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">        </span>{<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>            </font></span><span style="COLOR: green">//lock(typeof(Program))<o :p></o></span></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">            </span>{<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>                </font></span><span style="COLOR: blue">int</span><font color=#000000> i = Program.globalni;<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">                </span>i++;<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>                </font></span><span style="COLOR: teal">Thread</span><font color=#000000>.Sleep(</font><span style="COLOR: blue">new</span><font color=#000000> </font><span style="COLOR: teal">Random</span><font color=#000000>().Next(2000));<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">                </span>Program.globalni = i;<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><span style="mso-spacerun: yes"><font color=#000000>                </font></span><span style="COLOR: teal">Console</span><font color=#000000>.WriteLine(Program.globalni.ToString());<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">            </span>}<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">        </span>}<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000><span style="mso-spacerun: yes">    </span>}<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><span style="FONT-SIZE: 10pt; FONT-FAMILY: 'Courier New'; mso-no-proof: yes"><font color=#000000>}<o :p></o></font></span></p><p class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><o :p><font color=#000000 size=3> </font></o></p><p></p></font>
