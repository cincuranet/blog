---
title: "Union and Concat in LINQ to Entities"
date: 2012-11-01T14:29:09Z
tags:
  - Entity Framework
  - LINQ
category: none
layout: post
---
<p>Few years back I wrote about "<a href="{% post_url 2008-05-07-227543-union-and-union-all-in-linq-to-sql %}">UNION and UNION ALL in LINQ to SQL</a>" and comment there today made me re-think it again. Everything that's written there is correct. But it might be little bit confusing to see the query being generated from Entity Framework. Actually the query is generated by <code>SqlClient</code> and every 3<sup>rd</sup> party provider should do the same.</p>

<p>Basically, as written in above mentioned article, <a href="http://msdn.microsoft.com/en-us/library/bb351755.aspx">Concat</a> generates query, that has the semantic of <code>UNION ALL</code>. Similarly the <a href="http://msdn.microsoft.com/en-us/library/bb156049.aspx">Union</a> generates query with <code>UNION</code> semantic.</p>

<p>Let's check that. I'll use simple Entity Framework's Code First base set up. And some queries.</p>

<pre class="brush:csharp">
class MyContext : DbContext
{
	public MyContext()
		: base(new SqlConnection(@"Initial Catalog=test;Data Source=(localdb)\mssql;Integrated Security=True;Pooling=false;"), true)
	{

	}

	public IDbSet&lt;Test1&gt; Test1 { get; set; }
	public IDbSet&lt;Test2&gt; Test2 { get; set; }
}

class Test1
{
	public int Id { get; set; }
	public int FooBar { get; set; }
}
class Test2
{
	public int Id { get; set; }
	public int FooBar { get; set; }
}
</pre>

<pre class="brush:csharp">
using (var ctx = new MyContext())
{
	Console.WriteLine(ctx.Test1.Select(x =&gt; x.Id).Union(ctx.Test2.Select(x =&gt; x.Id)).ToString());
	Console.WriteLine(ctx.Test1.Select(x =&gt; x.Id).Concat(ctx.Test2.Select(x =&gt; x.Id)).ToString());
}
</pre>

<p>Running this code, produces following queries.</p>

<pre class="brush:sql">
SELECT
[Distinct1].[C1] AS [C1]
FROM ( SELECT DISTINCT
        [UnionAll1].[Id] AS [C1]
        FROM  (SELECT
                [Extent1].[Id] AS [Id]
                FROM [dbo].[Test1] AS [Extent1]
        UNION ALL
                SELECT
                [Extent2].[Id] AS [Id]
                FROM [dbo].[Test2] AS [Extent2]) AS [UnionAll1]
)  AS [Distinct1]
</pre>
<pre class="brush:sql">
SELECT
[UnionAll1].[Id] AS [C1]
FROM  (SELECT
        [Extent1].[Id] AS [Id]
        FROM [dbo].[Test1] AS [Extent1]
UNION ALL
        SELECT
        [Extent2].[Id] AS [Id]
        FROM [dbo].[Test2] AS [Extent2]) AS [UnionAll1]
</pre>

<p>Both queries are using <code>UNION ALL</code>. What's wrong? The key magic is in usage of <code>DISTINCT</code> keyword in first query. That basically turns <code>UNION ALL</code> into <code>UNION</code>. Because <code>UNION</code> is all rows from both sets <i>without</i> duplicates. And <code>DISTINCT</code> will remove these duplicates.</p>

<p>Yes, little bit hidden, but the semantic is kept.</p>
