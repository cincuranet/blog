---
title: "Disappearing order by clauses when composing query"
date: 2010-10-07T11:23:09Z
tags:
  - LINQ
redirect_from: /id/232068
category: none
layout: post
---
<p>If you're composing queries in LINQ on various places, utilizing the delayed execution, you might be surprised, that some of your dynamically added <a href="http://msdn.microsoft.com/en-us/library/system.linq.queryable.orderby.aspx">OrderBy</a>s are not in final query.</p>

<p>Imagine we have a simple table with <code>a</code> and <code>b</code> columns (and primary key). If you write following query with ordering adding (it can be in different method etc.) ...</p>

<pre class="brush:csharp">
IQueryable&lt;OrderingTest&gt; tmp1 = context.OrderingTest;
tmp1 = tmp1.OrderBy(x =&gt; x.a);
tmp1 = tmp1.OrderBy(x =&gt; x.b);
//Console.WriteLine((tmp1 as ObjectQuery).ToTraceString());
</pre>

<p>... the result will contain sorting based only on <code>b</code> column. That's because the last <code>OrderBy</code> took the precedence.</p>

<p>To make it work as expected you have to write it like this.</p>

<pre class="brush:csharp">
IQueryable&lt;OrderingTest&gt; tmp2 = context.OrderingTest;
tmp2 = tmp2.OrderBy(x =&gt; x.a);
if (tmp2 is IOrderedQueryable&lt;OrderingTest&gt;)
	tmp2 = (tmp2 as IOrderedQueryable&lt;OrderingTest&gt;).ThenBy(x =&gt; x.b);
//Console.WriteLine((tmp2 as ObjectQuery).ToTraceString());
</pre>

<p>The secondary (and further ordering) needs to be done via <a href="http://msdn.microsoft.com/en-us/library/system.linq.queryable.thenby.aspx">ThenBy</a> method, which is available on <a href="http://msdn.microsoft.com/en-us/library/bb340178.aspx">IOrderedQueryable&lt;T&gt;</a>. That's the reason for casting.</p>

<p>Sure it's always safer to do this in one place directly, but sometimes the query is and has to be build on various places. Then think if a call to <code>OrderBy</code> could or couldn't be at some place before.</p>

<p><small>You can always do some "dummy sort", like <code>_ =&gt; 0</code>, initially and then use only <code>ThenBy</code>, but I personally don't like playing with the intelligence of optimizer. It may have bad impact on performance.</small></p>