---
title: "Spatial data and Entity Framework - from real world usage"
date: 2010-02-24T21:57:59Z
tags:
  - Entity Framework
  - Geometry
  - LINQ
  - MS SQL Server
  - Spatial data
  - T-SQL
redirect_from: /id/231242
category: none
layout: post
---
<p><a href="http://thedatafarm.com/blog/data-access/yes-you-can-read-and-probably-write-spatial-data-with-entity-framework/">Julie Lerman created a post</a> about spatial data usage in Entity Framework. Her conclusions are correct. But because from last three projects I did on Entity Framework two of them are working with spatial data (every customer wants a Google Maps or Bing Maps on website, it's like cup holders in cars) I would like share my solution as well some ideas behind why I used this approach.</p>

<p>First and foremost Entity Framework doesn't support spatial data now. So you have to create some workaround. The idea getting the data through blob is exactly what I created. In my tables where I need to save some coordinates (it's mainly a point) I create simple column with this data type – I consider this clean initial work better, because maybe sometimes/somewhere/somebody will work with this structures so to have it clean. Then for the workaround I add XXX_bin column where I'll store the binary representation of spatial data and use it for Entity Framework. Something like this:</p>

<pre class="brush:sql">
[Location] geography Default geography::STGeomFromText('POINT EMPTY', 4326) NOT NULL,
[Location_bin] Varbinary(max) NOT NULL,
</pre>

<p>Because I'm working only through Entity Framework I need to update the <code>Location</code> automatically as there might be (and are) indices or other stuff working with it. To make it transparent I'm using <code>insert or update</code> trigger:</p>

<pre class="brush:sql">
if (update(Location_bin))
begin
  update %tablename% set
    Location = geography::STGeomFromWKB(Location_bin, 4326)
  where
     ID in (select ID from inserted);
end
</pre>

<p>If you expect somebody updating the <code>Location</code> column directly too, you need to create another trigger and make sure you'll not end up in infinite loop.</p>

<p>To support the – in my case – points for UI developers I create in every entity computed property turning <code>Location_bin</code> into my <code>LatLong</code> struct. This struct is using <a href="http://msdn.microsoft.com/en-us/library/microsoft.sqlserver.types(SQL.105).aspx">Microsoft.SqlServer.Types</a> namespace.</p>

<pre class="brush:csharp">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Data.SqlTypes;
using Microsoft.SqlServer.Types;

namespace FooBar
{
    public struct LatLong
    {
        public double Lat { get; set; }
        public double Long { get; set; }

      public static LatLong FromSqlBytes(byte[] bytes)
      {
        SqlGeography g = SqlGeography.STGeomFromWKB(new SqlBytes(bytes), 4326);
        return new LatLong { Lat = g.Lat.Value, Long = g.Long.Value };
      }

      public byte[] ToSqlBytes()
      {
        return SqlGeography.Point(this.Lat, this.Long, 4326).STAsBinary().Buffer;
      }
    }
}
</pre>

<pre class="brush:csharp">
public LatLong Location
{
  get
  {
    return LatLong.FromSqlBytes(this.Location_bin);
  }
  set
  {
    this.Location_bin = value.ToSqlBytes();
  }
}
</pre>

<p>This creates almost seamless support for other developers when using spatial data in Entity Framework – inserting, updating, deleting all works without notice from others (if you're not looking into internal implementation).</p>

<p>There are only two problems, both solvable.</p>

<p>First one is that developer cannot filter/sort/… using Location property. This isn't probably a big problem. As (s)he doesn't have spatial methods (like i.e. <code>Distance</code>) available, so the queries will not make sense. Which brings me to the other problem and that's the querying. With EFv1 I created stored procedures for these queries and returned data through these. Same works for EFv4. If you have strict set of results you need, this is probably easiest solution. The other one, working in EFv4 is LINQ function imports via <a href="http://msdn.microsoft.com/en-us/library/system.data.objects.dataclasses.edmfunctionattribute(VS.100).aspx">EdmFunction</a> attribute. For computations I'm going to use I create function in T-SQL doing the work and I <a href="{{ site.url }}{% post_url 2009-10-11-230897-model-defined-function-as-a-method-on-entity-or-on-type-for-store-function %}">import it</a> into my solution thru above noted attribute. The simple <code>Distance</code> method may look like:</p>

<pre class="brush:sql">
create function Distance
(
  @Location_bin1 varbinary(max),
  @Location_bin2 varbinary(max)
)
returns int
as
begin
  return geography::STGeomFromWKB(@Location_bin1, 4326).STDistance(geography::STGeomFromWKB(@Location_bin2, 4326));
end
</pre>

<p>And</p>

<pre class="brush:csharp">
[EdmFunction("model.Store", "Distance")]
internal static int Distance(this byte[] location1, byte[] location2)
{
  throw new NotSupportedException();
}
</pre>

<p>Sure, when calling this function for a big resultsets it may be a performance bottleneck <small>(I recommend doing there as much work as possible, even at the price of more functions doing similar stuff, to not create a deep function calls.)</small>, but with additional filters it works well.</p>

<pre class="brush:csharp">
protected IQueryable&lt;Something&gt; SomethingInDistance(LatLong point, int distance)
{
  byte[] spatialData = point.ToSqlBytes();
  return this.Somethings.Where(o => o.Location_bin.Distance(spatialData) &lt; distance);
}
</pre>

<p>Another way could be to create a view (if you know the parameters in advance) and do explicit join (table/entityset &lt;&gt; view/entityset) in EF. Or do the filtering on client (if reasonably small). And I'm sure I'll find other ways how to get the data you want back, simply choose what fits your needs best.</p>

<p>Although it may look like a lot of work, it isn't. In fact you're pretty fast (there's a high level of reusability) if you know what to do (and after one implementation you will).</p>