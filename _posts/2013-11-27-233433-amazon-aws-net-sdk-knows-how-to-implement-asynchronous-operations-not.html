---
title: "Amazon AWS's .NET SDK knows how to implement asynchronous operations. Not!"
date: 2013-11-27T12:28:00Z
tags:
  - Best practice or not?
  - Multithreading/Parallelism/Asynchronous/Concurrency
  - Storage &amp; Backup
  - Amazon AWS
  - Cloud
category: none
layout: post
---
<p>Recently I was working on an application of my own and as I was in it I decided to check what updates to NuGet packages are available. I like to keep up to date to avoid any huge updates and surprises. And I also noticed <a href="http://www.nuget.org/packages/AWSSDK/">AWS SDK</a> had a new version, new major version.</p>

<p>Little bit worried about some breaking changes, but anyway I decided to update. The application uses <a href="http://aws.amazon.com/s3/">AWS S3</a> heavily so new code shouldn't hurt. After solving some compilation errors as some changes were, of course, breaking, I realized I see in IntelliSense methods with <code>Async</code> suffix. Great I thought; I can get rid of some of my helpers and very likely the finally implemented asynchronous operations properly. Before, using the <code>BeginXxx</code> and <code>EndXxx</code> was wokring, but these were sometimes blocking or spinning new threads. Definitely something you don't want when trying to scale with limited resources.</p>

<!-- excerpt -->

<p>As I started changing the methods and removing explicit callbacks I started also small testing to see how it performs. What a (bad) surprise I saw, when the results and resource usage was not what I would expect from nice fully (given a lot of it is actual HTTP calls to AWS) asynchronous code. It was time to dive into code. :) After walking through code a little I started to see crazy stuff. Like crazy. Let's say you want to upload some file to S3, without too much hassle. There's a <a href="http://docs.aws.amazon.com/sdkfornet1/latest/apidocs/html/T_Amazon_S3_Transfer_TransferUtility.htm"><code>TransferUtility</code></a> class and part of it is visible <a href="https://github.com/aws/aws-sdk-net/blob/10fef6f83449b416044573b0cf39ea3c6621edd7/AWSSDK_DotNet45/Amazon.S3/Transfer/TransferUtility.async.cs#L142">here</a>. If you'll jump to <a href="https://github.com/aws/aws-sdk-net/blob/10fef6f83449b416044573b0cf39ea3c6621edd7/AWSSDK_DotNet45/Amazon.S3/Transfer/TransferUtility.async.cs#L344">ExecuteAsync method</a>, which is suspicious anyway, you find this <small>(you can click on link before to see the code directly or on image below)</small>:</p>

<a href="http://i.blog.cincura.net/aws_sdk_executeasync.png"><img src="http://i.blog.cincura.net/thumbs/aws_sdk_executeasync.png" /></a>

<p>Who the hell was implementing that? It's starting a new task (that's ultimately going to be executed somewhere, very likely <a href="http://msdn.microsoft.com/en-us/library/system.threading.threadpool(v=vs.110).aspx"><code>ThreadPool</code></a>) and then spinning a new <a href="http://msdn.microsoft.com/en-us/library/system.threading.thread(v=vs.110).aspx"><code>Thread</code></a> followed by immediate blocking (calling <a href="http://msdn.microsoft.com/en-us/library/system.threading.thread.join(v=vs.110).aspx"><code>Join</code></a>). The method being called is blocking as well, because the signature is <code>Func&lt;T&gt;</code>. That's like a nightmare. Creating threads, blocking, :o :\.</p>

<p>Given <a href="http://aws.amazon.com/">Amazon AWS</a> is one of, let's say, top 3 players in cloud today I would expect the code to have at least "some" quality. To be honest, I was playing even for a while with the idea of implementing it properly, at least in S3 I use. But then I realized that with my limited <i>free</i> time I would rather spend it on <a href="http://www.id3renamer.com">ID3 renamer</a> or <a href="https://github.com/cincuranet/NETProvider">FirebirdSql.Data.FirebirdClient</a> (or <a href="https://github.com/nuodb/nuodb-dotnet">NuoDb.Data.Client</a>).</p>

<p>And I also moved storage for this application to <a href="http://www.windowsazure.com/">Azure</a>. :) So far no nasty surprise.</p>
