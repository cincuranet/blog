---
title: "Default transanction isolation level in PHP for Firebird"
date: 2012-09-17T06:21:04Z
tags:
  - Databases in general
  - Firebird
  - PHP
category: none
layout: post
---
<p>I was hunting some problem in PHP application and thanks to <a href="http://www.firebirdsql.org/rlsnotesh/rlsnotes25.html#rnfb25-trace">Trace API in Firebird</a> I found terrible default value in PHP. What value? It's the default transaction isolation level value. In 99% of languages/environments in something close to read committed. But not in PHP.</p>

<p>Let's have a look at it. If you start a new transaction (or if one is started internally, where you cannot change the isolation level) where you don't explicitly specify isolation level the <code>IBASE_DEFAULT</code> is used. But this is <code>IBASE_WRITE|IBASE_CONCURRENCY|IBASE_WAIT</code>. This is read-write wait transaction in concurrency mode. This mode is most restrictive, nothing close to read committed. And to make it worse, there's no way to change this default value in runtime. You can only do it recompiling sources, nothing to be viable in most cases.</p>
<p>So how to solve it? Well, if you created yourself some abstraction layer over <code>ibase_xxx</code>/<code>fbird_xxx</code> function you'll change it there and you're done. If not, you're screwed. :) OK, just kidding. You can play with <code><a href="http://php.net/manual/en/function.override-function.php">override_function</a></code> to override <code><a href="http://php.net/manual/en/function.ibase-query.php">fbird_query</a></code>, <code><a href="http://php.net/manual/en/function.ibase-prepare.php">fbird_prepare</a></code> etc., but when you're in it, maybe it's time to create simple thin abstraction.  That's what I did. Find & Replace worked for changing the actual code. :) For the rest I created simple functions like <code>DbQuery</code>, <code>DbPrepare</code> etc. These functions take the transaction, which was created by another function <code>DbTransaction</code> and stored (i.e. in <code>$GLOBALS</code>, dirty right? 8-)), when first needed (and then used until commit/rollback or end of the page's l</p>ife).

<pre class="brush:php">
function DbQuery()
{
	$args = func_get_args();
	array_unshift($args, $GLOBALS['tx']);
	return call_user_func_array('fbird_query', $args);
}
</pre>

<p>It's nothing special, only few small pieces to make to together work. First the function doesn't declare any input parameters, but in fact there are some. Yeah, dynamic languages. I get these via <code><a href="http://php.net/manual/en/function.func-get-args.php">func_get_args</a></code>, then push to the first position the transaction to use (here I'm using the dirty <code>$GLOBALS</code> ;)). Finally I use <code><a href="http://www.php.net/manual/en/function.call-user-func-array.php">call_user_func_array</a></code> to call <code><a href="http://php.net/manual/en/function.ibase-query.php">fbird_query</a></code>. Function <code><a href="http://php.net/manual/en/function.ibase-query.php">fbird_query</a></code> takes variable number of arguments so it's not easy to call it directly with parameters in array as I have. I have to thank people in firebird-php mailing list, because I completely forgot about it, though I'm using exactly the same at other places in same project. Return values are same as from <code><a href="http:</p>//php.net/manual/en/function.ibase-query.php">fbird_query</a></code>, so you can then start fetching rows and so on (and it's also good idea to create wrappers for these too, who knows what will strike in the future).

<p>Remember Firebird and PHP is a good combination.</p>