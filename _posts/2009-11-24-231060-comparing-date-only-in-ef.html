---
title: "Comparing date only in EF"
date: 2009-11-24T14:52:11Z
tags:
  - Entity Framework
  - Entity SQL
  - LINQ
category: devel
layout: post
---
From time to time you may need to compare only date part of datetime/timestamp field in your database i.e. for filtering. In EFv1 this is a little bit problem, in EFv4 (now beta 2) better.

Let's start with EFv1. If you try to write something like this:
<pre class="brush:csharp">.Where(x =&gt; x.DateTimeColumn.Date == DateTime.Today)</pre>
You'll end up with nice exception. Simply EF is not able to translate it. To solve this problem I created handy (for me) method, that will do simply expansion comparing Day, Month, Year, so you don't have to write it over and over again.
<pre class="brush:csharp">public static Expression&lt;Func&lt;TElement, bool&gt;&gt; DateEqual&lt;TElement&gt;(Expression&lt;Func&lt;TElement, DateTime&gt;&gt; valueSelector, DateTime dt)
{
	if (valueSelector == null)
		throw new ArgumentException("valueSelector");

	ParameterExpression p = valueSelector.Parameters.Single();

	Expression ex = Expression.And(
		Expression.Equal(
			Expression.MakeMemberAccess(valueSelector.Body, typeof(DateTime).GetMember("Day").Single()),
			Expression.Constant(dt.Day)
			),
		Expression.And(
			Expression.Equal(
				Expression.MakeMemberAccess(valueSelector.Body, typeof(DateTime).GetMember("Month").Single()),
				Expression.Constant(dt.Month)
				),
			Expression.Equal(
				Expression.MakeMemberAccess(valueSelector.Body, typeof(DateTime).GetMember("Year").Single()),
				Expression.Constant(dt.Year)
				)
			)
		);
	return Expression.Lambda&lt;Func&lt;TElement, bool&gt;&gt;(ex, p);
}</pre>
So you can write i.e.:
<pre class="brush:csharp">.Where(Ext.DateEqual&lt;DateTimeEntity&gt;(x =&gt; x.DateTimeColumn, DateTime.Today.AddDays(-20)))</pre>
One modification I have in my head, is to extend it to support comparing two columns in database. But that shouldn't be hard.

On the other hand, EFv4 contains couple of new <a href="http://msdn.microsoft.com/en-us/library/bb738563(VS.100).aspx">canonical functions</a>, for datetime/timestamp as well. One that's useful for this case is <a href="http://msdn.microsoft.com/en-us/library/dd395596(VS.100).aspx">TruncateTime</a>, also exported for LINQ usage with <a href="http://msdn.microsoft.com/en-us/library/system.data.objects.dataclasses.edmfunctionattribute(VS.100).aspx">EdmFunctionAttribute</a>. With it, you can write queries little bit easier. Still not directly <code>.Date</code>, but i.e.:
<pre class="brush:csharp">.Where(x =&gt; EntityFunctions.TruncateTime(x.DateTimeColumn) == DateTime.Today)</pre>
Comparing two columns is available too. Sure, your provider needs to support this new function, but that should be no problem for all provider writers.

Maybe the future EF improvement could be to support <code>.Date</code> for translation too. ;)
