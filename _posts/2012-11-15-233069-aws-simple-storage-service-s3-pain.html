---
title: "AWS Simple Storage Service (S3) pain"
date: 2012-11-15T09:36:39Z
tags:
  - .NET
  - Amazon AWS
  - Cloud
  - Storage &amp; Backup
redirect_from: /id/233069
category: none
layout: post
---
<p>When we worked together with <a href="http://rarous.net/">Aleš Roubíček</a> using Windows Azure cloud, we faced quite a few surprises with applications in cloud. Especially when the application isn't small and is using a lot of "cloud" services. Sometimes we used hashtag on Twitter for it: <a href="https://twitter.com/search?q=%23cloudlife"><i>#cloudlife</i></a>.</p>

<p>Last week I was creating fairly simple tool that allows (or should allow) me to copy some files to S3 bucket. I had some special needs because the folder where the files were was heavily changed and the tool needed to handle that. Because <a href="http://aws.amazon.com">AWS</a> has <a href="http://aws.amazon.com/sdkfornet/">SDK for .NET</a> I was not expecting that to be extremely difficult. How wrong I was.</p>

<p>Every file in S3 has <a href="http://en.wikipedia.org/wiki/HTTP_ETag">ETag</a> associated. And you will get it with almost every request, i.e. when you're listing bucket. Good candidate for decision whether to copy the file (because it was changed) or not. The SDK contains <a href="http://docs.amazonwebservices.com/sdkfornet/latest/apidocs/html/T_Amazon_S3_Util_AmazonS3Util.htm"><code>AmazonS3Util</code></a> class which allows you to compute the checksum/ETag. Great, should be piece of cake. Not so fast. The SDK and S3 itself has some gotchas - <i>#cloudlife</i>.</p>

<p>First the ETag returned from SDK is inside double quotes. But the value from <code>AmazonS3Util</code> is not. I can fix that. Could be worse. Let's move forward. For big or huge files the new multipart upload (you are uploading the file in smaller chunks) is recommended. Boom. Checksum/ETag is then different. For same file uploaded "normal" way and multipart the ETag differs. Sadly the <code>AmazonS3Util</code> can compute only the checksum for "normal" type of upload. Never mind. Next. Every file can have some metadata associated, I can store my own checksum there. I will need to request metadata in separate call, but I can live with that. So let's use <a href="http://docs.amazonwebservices.com/sdkfornet/latest/apidocs/html/M_Amazon_S3_Transfer_TransferUtilityUploadRequest_WithMetadata_1.htm"><code>WithMetadata</code></a> method to add some key/value. Good no problem so far. Retrieving metadata. Suspicious method <a href="http://docs.amazonwebservices.com/sdkfornet/latest/apidocs/html/M_Amazon_S3_AmazonS3Client_GetObjectMetadata.htm"><code>GetObjectMetadata</code></a> (and the <a href="http://docs.amazonwebservices.com/sdkfornet/latest/apidocs/html/M_Amazon_S3_AmazonS3Client_BeginGetObjectMetadata.htm"><code>BeginGetObjectMetadata</code></a>/<a href="http://docs.amazonwebservices.com/sdkfornet/latest/apidocs/html/M_Amazon_S3_AmazonS3Client_EndGetObjectMetadata.htm"><code>EndGetObjectMetadata</code></a> counterparts) returns <a href="http://msdn.microsoft.com/en-us/library/system.collections.specialized.namevaluecollection.aspx">NameValueCollection</a>, I can probably find the same key as I stored there. Not so fast. My key originally stored as i.e. <code>foobar</code> is now <code>x-amz-meta-foobar</code>. Maybe the <code>WithMetadata</code> could enforce that in input, so I know there's always this prefix. I don't like hidden magic. Almost there. Every request is also signed (that's, also, why we have the key and secret) to be sure the request was not changed on the way etc. (headers, parameters etc. are part or the input for signature). SDK handles the signature for me. Badly. As long as you use US-ASCII characters in filenames/paths or better to say keys for storing the data, you're fine. Try to put there some "special" characters, like in my case diacritics. Suddenly the signature doesn't match what's expected and server will not allow me proceed further. Yes you're right, the encoding issue. Sadly I don't know currently workaround. Hope it'll be fixed soon. Hitting wall every while.</p>

<p>And you know what? Some limitations and challenges I like (ETag issue. These are reasons why I like development and creating software. Some I don't like (encoding issue), I shows somebody wasn't doing own work properly. And why <i>#cloudlife</i>? From marketing we're told the cloud is so cool and so ... best, it'll solve all our problems and we expect it to be perfect. But it's not. It's piece of architecture as every other component in your solution. You should expect issues.</p>

<p>Have fun, develop for fun.</p>